import st7565 as display

try:
    import tools
    if hasattr(display, "graphics") and not hasattr(display.graphics, "pixels_changed"):
        display.graphics = tools.refresh(display.graphics, pixels_changed=200)
except Exception:
    pass

# Copyright (c) 2025 CalSci
# Licensed under the MIT License.

import machine
DISPLAY_PINS = (9, 11, 10, 13, 12)  # cs, rs, rst, sda, sck

try:
    display.init(*DISPLAY_PINS)
    if hasattr(display, "on"):
        display.on()
except Exception as e:
    print("Display init error:", e)

# machine.freq(240000000)
if machine.wake_reason() == 2:
    machine.reset()
try:
    display.clear_display()
except Exception as e:
    print("Display clear error:", e)
# display.set_contrast(0)
cal_sci_buffer = bytearray(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0   \xa0\xa0\xa0\xa0            \xa0\xa0\xa0     \xa0\xa0\xa0\xa0             \xa0\xa0    \xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\x00\x00\x1f?  1\x11\x00\x00\x10:**><\x00\x00\x00 ?? \x00\x00\x00\x137$$=\x19\x00\x00\x1c>""6\x14\x00\x00\x00\x00>>\x00\x00\x00\x00\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xc0\xc1\x01\x01\xc1\xc1\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01A\xc1\xc1\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\x01\xc1\xc1\x01\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0f\x1f\x10\x10\x1f\x0f\x00\x00\x1f\x1f\x01\x01\x1f\x1e\x00\x00\x00\x10\x1f\x1f\x10\x00\x00\x00\x0e\x1f\x15\x15\x17\x16\x00\x00\x08\x1d\x15\x15\x1f\x1e\x00\x00\x12\x17\x15\x15\x1d\x08\x00\x00\x1f\x1f\x01\x01\x1f\x1e\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\x0fxx\x0f\x07\x00\x008|DD|8\x00\x00<|@@|<\x00\x00||\x04\x04\x0c\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00A\x7f\x7fA\x00\x00\x00||\x180\x18||\x00 tTT|x\x00\x00\x98\xbc\xa4\xa4\xfc|\x00\x00\x00\x00}}\x00\x00\x00\x00||\x04\x04|x\x00\x00 tTT|x\x00\x04\x04?\x7fDd \x00\x00\x00\x00}}\x00\x00\x00\x008|DD|8\x00\x00||\x04\x04|x\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')
display.graphics(cal_sci_buffer)
import gc
from sleeping_features import keypad_normal
keypad_normal()
# import machine
from bootup_configs import bootup
# print("Pin value of 14 = ", machine.Pin(14).value())
opin = machine.Pin(14, machine.Pin.OUT, value=1, hold=False)  # Reinitialize the pin for deepsleep keypad
# print("Pin value of 14 = ", machine.Pin(14).value())
# from test_thread import run_thread
# opin.hold(False)
# from data_modules.object_handler import display
# import st7565 as display
# st7565_display_pins={"cs1":9, "rs":11, "rst":10, "sda":13, "sck":12} #2.9
# # display.init(st7565_display_pins["cs1"], st7565_display_pins["rs"], st7565_display_pins["rst"], st7565_display_pins["sda"], st7565_display_pins["sck"])
# # display.init(st7565_display_pins["cs1"], st7565_display_pins["rs"], st7565_display_pins["rst"], st7565_display_pins["sda"], st7565_display_pins["sck"]) #2.9
# display.init(9, 11, 10, 13, 12)
# display.write_instruction(0x81)
# display.write_instruction(9)
# cal_sci_buffer=bytearray(b'\x00\x00\x00\x00\x00\x00\x00\xc0\x03\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xe0\x07\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xe0\x07\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xf0\x07\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xf3\xcf\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xff\xff\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xe0\xff\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xc0\x7f\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xe7\xc0\x7f\xe7\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00?\xff\xe0\xff\xff\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xf8\x0f\xff\xff\xf0\x1f\x80\x00\x00\x00\x00\x00\x00\x00\x00\x03\xe0\x03\xff\xff\xc0\x03\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x07\x80\x00\xff\xff\x00A\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x07\x00\x00\x7f\xfe\x00\xe0\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x0e\x00\x00\x1f\xf8\x00\xe0p\x00\x00\x00\x00\x00\x00\x00\x00\x0e\x00\x00\x0f\xf0\x00\xe0p\x00\x00\x00\x00\x00\x00\x00\x00\x1c\x00\x00\x07\xe0\x00\xe08\x00\x00\x00\x00\x00\x00\x00\x00\x1c\x7f\xf0\x03\xe0\x00\xe08\x00\x00\x00\x00\x00\x00\x00\x00\x1c\x7f\xf0\x03\xc0\x1f\xff8\x00\x00\x00\x00\x00\x00\x00\x00\x1c\x7f\xf0\x03\xe0\x1f\xff8\x00\x00\x00\x00\x00\x00\x00\x00\x1c\x00\x00\x07\xe0\x00`8\x00\x00\x00\x00\x00\x00\x00\x00\x0e\x00\x00\x0f\xf0\x00\xe0p\x00\x00\x00\x00\x00\x00\x00\x00\x0e\x00\x00\x1f\xf8\x00\xe0p\x00\x00\x00\x00\x00\x00\x00\x00\x07\x00\x00|>\x00\xe0\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x07\x80\x00\xf8\x1f\x00a\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x03\xc0\x03\xe0\x07\xc0\x03\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x01\xf8\x0f\xc0\x03\xf0\x1f\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\xff\xff\xff\xff\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00?\xff\xff\xff\xff\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xff\xff\xff\xff\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00?\xff\xff\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00?\xff\xff\xfc\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x008\x00\x00\x1c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00<\x00\x00\x1c\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1c\x00\x00<\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\xff\xff\xf8\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\xff\xff\xf8\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0f\xff\xff\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0f\xff\xff\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x07\xff\xff\xe0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\xe0\x07\xc0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\xf0\x0f\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xfc?\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x7f\xfe\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x1f\xf8\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x0f\xf0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x10\x00\x08\x10\x00\x00\x80\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\x00\x00\x08\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x08\x00\x00\x08\x00\x00\x00\x00\x00Fc1\x90\xff\x13\xc3\x8b\x91\xe5\xdc\x80\xf3\xbf\x00\x00fs9\x90\xcd\x92$L\x92&H\x81\x13\'\x00\x00.W+\x90\x88\x93\x04\x08\xd0$h\x81\x1a#\x00\x00*\xd5j\xb0\x88\x91\xcc\x08\xd3\xe4h\x83\x1ac\x00\x00+\x95\xca\xe0\x88\x90d\x08\xd2$h\x81\x1ac\x00\x009\x9c\xce`\x88\x96$H\xd6dh\x81\x12\'\x00\x00\x11\x88\xc4l\x88\x93\xc3\x88\xd3\xb4n\x98\xf2?\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00"\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00<\x00')
# cal_sci_buffer = bytearray(b'\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\xe0\xf0\x10\x100 \x00\x00\x00@@@\xc0\x80\x00\x00\x00\x10\xf0\xf0\x00\x00\x00\x00`\xf0\x90\x90\xb0 \x00\x00\x80\xc0@@\xc0\x80\x00\x00\x00\x00\xd0\xd0\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x03\x07\x04\x04\x06\x02\x00\x00\x02\x07\x05\x05\x07\x07\x00\x00\x00\x04\x07\x07\x04\x00\x00\x00\x02\x06\x04\x04\x07\x03\x00\x00\x03\x07\x04\x04\x06\x02\x00\x00\x00\x00\x07\x07\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00')
# display.graphics(cal_sci_buffer)
# display.write_instruction(0x81) #for only 3.0
# display.write_instruction(0x06)
gc.enable()
print("free ram initially=", gc.mem_free())
print("ram allocated initially=", gc.mem_alloc())
from apps.settings.backlight import backlight_pin
# backlight_pin.off() #3.0
backlight_pin.on() #2.9
# from test_thread import run_thread
# run_thread()
# import uasyncio as asyncio
# from test_async import main
# asyncio.run(main())

import builtins
import _thread
from data_modules.object_handler import text, menu, form, text_refresh, menu_refresh, form_refresh, typer, data_bucket
# builtins.display=display
builtins.text=text
builtins.menu=menu
builtins.form=form
builtins.text_refresh=text_refresh
builtins.text_refresh=menu_refresh
builtins.text_refresh=form_refresh
builtins.typer=typer
_thread.start_new_thread(bootup, ())

#hello world
# === Triple-boot partition helpers (merged from triple_boot/micropython/boot.py) ===
try:
    import esp32
except Exception:
    esp32 = None

import machine as _triple_machine
import time as _triple_time

print("=================================")
print("  Triple Boot Commands Ready")
print("=================================")
print("Commands:")
print("  boot.switch_to_cpp()   - Reboot into C++")
print("  boot.switch_to_rust()  - Reboot into Rust")
print("  boot.info()            - Show current partition")
print("=================================")


def info():
    """Show current running partition info."""
    if esp32 is None:
        print("esp32 partition API not available in this firmware")
        return
    cur = esp32.Partition(esp32.Partition.RUNNING)
    print("Running from:", cur.info())
    print("All app partitions:")
    for p in esp32.Partition.find(esp32.Partition.TYPE_APP):
        print(" ", p.info())


def switch_to_cpp():
    """Switch to C++ (ota_1) and reboot."""
    _switch_to("ota_1", "C++")


def switch_to_rust():
    """Switch to Rust (ota_2) and reboot."""
    _switch_to("ota_2", "Rust")


def _decode_partition_field(value):
    if isinstance(value, bytes):
        try:
            return value.decode()
        except Exception:
            return None
    if isinstance(value, str):
        return value
    return None


def _partition_by_label(label):
    # Fast path for firmwares where Partition(label) is supported.
    try:
        return esp32.Partition(label)
    except Exception:
        pass

    # Fallback: scan app partitions and match label from info().
    try:
        parts = esp32.Partition.find(esp32.Partition.TYPE_APP)
    except Exception:
        return None

    for part in parts:
        try:
            info = part.info()
        except Exception:
            continue

        fields = info if isinstance(info, (tuple, list)) else (info,)
        for field in fields:
            if _decode_partition_field(field) == label:
                return part
    return None


def _switch_to(label, name):
    """Internal: set boot partition and restart."""
    if esp32 is None:
        print("esp32 partition API not available in this firmware")
        return
    try:
        part = _partition_by_label(label)
        if part is None:
            print("Error switching to", label, ": partition not found")
            return
        part.set_boot()
        print("Next boot:", name, "(", label, ")", sep="")
        print("Restarting in 1 second...")
        _triple_time.sleep(1)
        _triple_machine.reset()
    except Exception as e:
        print("Error switching to", label, ":", e)
